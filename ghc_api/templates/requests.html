<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot API Proxy - Request Browser</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .navbar-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .navbar-actions a, .navbar-actions button {
            color: white;
            text-decoration: none;
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            transition: background 0.2s;
            border: none;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .navbar-actions a:hover, .navbar-actions button:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 52px);
        }

        /* Left panel - Detail view */
        .detail-panel {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e0e0e0;
        }

        .detail-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .detail-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }

        .detail-controls {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            flex-wrap: wrap;
            align-items: center;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
            font-size: 0.8125rem;
            color: #555;
        }

        .checkbox-group input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .checkbox-group .sub-checkbox {
            margin-left: 0.5rem;
            padding-left: 0.5rem;
            border-left: 1px solid #ddd;
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .detail-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 0.9375rem;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-section.hidden {
            display: none;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .overview-item {
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .overview-item label {
            font-size: 0.6875rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .overview-item .value {
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.25rem;
            word-break: break-all;
        }

        pre.json-display {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.75rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            margin: 0;
        }

        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .json-boolean { color: #569cd6; }
        .json-null { color: #569cd6; }

        /* Parsed message styles */
        .parsed-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message-box {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border-left: 4px solid;
        }

        .message-box.role-user {
            background: #e3f2fd;
            border-left-color: #1976d2;
        }

        .message-box.role-assistant {
            background: #f3e5f5;
            border-left-color: #7b1fa2;
        }

        .message-box.role-system {
            background: #fff3e0;
            border-left-color: #e65100;
        }

        .message-box.role-tool {
            background: #e8f5e9;
            border-left-color: #2e7d32;
        }

        .message-role {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        .message-content {
            font-size: 0.8125rem;
            line-height: 1.5;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.75rem;
            margin: 0.5rem 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
        }

        .content-block {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
        }

        .content-block:last-child {
            margin-bottom: 0;
        }

        .content-block-type {
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .tool-use-block {
            background: #e0e7ff;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .tool-use-name {
            font-weight: 600;
            font-size: 0.75rem;
            color: #3730a3;
        }

        .tool-use-input {
            font-family: monospace;
            font-size: 0.6875rem;
            background: rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.25rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
        }

        /* Right panel - Request list */
        .list-panel {
            width: 480px;
            min-width: 380px;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            resize: horizontal;
            overflow: hidden;
        }

        .list-controls {
            padding: 0.75rem;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .search-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            padding-left: 2rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.8125rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
        }

        .search-type-toggle {
            display: flex;
            gap: 0.25rem;
        }

        .search-type-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-type-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .search-type-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .per-page-select {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .per-page-select label {
            color: #666;
        }

        .per-page-select select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
            cursor: pointer;
        }

        .request-count {
            color: #666;
        }

        .request-list {
            flex: 1;
            overflow-y: auto;
        }

        .request-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.15s;
            background: white;
        }

        .request-item:hover {
            background: #f5f5f5;
        }

        .request-item.selected {
            background: #e8edff;
            border-left: 3px solid #667eea;
            padding-left: calc(1rem - 3px);
        }

        .request-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .request-item-time {
            font-size: 0.6875rem;
            color: #999;
        }

        .request-item-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .model-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            background: #e3e8ff;
            color: #667eea;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 600;
        }

        .model-translated {
            font-size: 0.625rem;
            color: #888;
            margin-left: 0.25rem;
        }

        .endpoint-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 3px;
            font-size: 0.6875rem;
            font-family: monospace;
        }

        .state-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.6875rem;
            font-weight: 600;
        }

        .state-badge.pending {
            background: #fff3e0;
            color: #e65100;
        }

        .state-badge.sending {
            background: #e3f2fd;
            color: #1565c0;
            animation: pulse 1.5s infinite;
        }

        .state-badge.receiving {
            background: #f3e5f5;
            color: #7b1fa2;
            animation: pulse 1.5s infinite;
        }

        .state-badge.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .state-badge.error {
            background: #ffebee;
            color: #c62828;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .request-item-stats {
            font-size: 0.6875rem;
            color: #666;
            display: flex;
            gap: 0.75rem;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem;
            border-top: 1px solid #e0e0e0;
            background: white;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 0.35rem 0.6rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-info {
            color: #666;
            font-size: 0.75rem;
            margin: 0 0.5rem;
        }

        .empty-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            text-align: center;
            padding: 1rem;
        }

        .empty-list h3 {
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
        }

        .empty-list p {
            font-size: 0.8125rem;
        }

        /* File input styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* Highlight for search matches */
        .search-highlight {
            background: #fff3cd;
            padding: 0 2px;
            border-radius: 2px;
        }

        @media (max-width: 900px) {
            .main-container {
                flex-direction: column-reverse;
            }

            .list-panel {
                width: 100%;
                max-width: none;
                height: 50%;
                resize: none;
            }

            .detail-panel {
                height: 50%;
                border-right: none;
                border-top: 1px solid #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Request Browser</h1>
        <div class="navbar-actions">
            <a href="/">Dashboard</a>
            <a href="/api/stats">API Stats</a>
            <button onclick="downloadRequests()" title="Download all requests as JSON Lines">Download .jl</button>
            <div class="file-input-wrapper">
                <button title="Load requests from JSON Lines file">Load .jl</button>
                <input type="file" id="file-input" accept=".jl,.jsonl" onchange="uploadRequests(this)">
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Left: Detail panel -->
        <div class="detail-panel">
            <div class="detail-header" id="detail-header">
                <h2>Select a request to view details</h2>
            </div>
            <div class="detail-controls" id="detail-controls" style="display: none;">
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="show-overview" checked>
                        Overview
                    </label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="show-request" checked>
                        Request
                    </label>
                    <label class="sub-checkbox">
                        <input type="checkbox" id="parse-request">
                        Parsed
                    </label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="show-response" checked>
                        Response
                    </label>
                    <label class="sub-checkbox">
                        <input type="checkbox" id="parse-response">
                        Parsed
                    </label>
                </div>
            </div>
            <div class="detail-content">
                <div class="detail-empty" id="detail-empty">
                    <span>Click on a request from the list to view its details</span>
                </div>
                <div id="detail-panes" style="display: none;">
                    <div class="detail-section" id="section-overview">
                        <div class="section-title">Overview</div>
                        <div class="overview-grid" id="overview-content"></div>
                    </div>
                    <div class="detail-section" id="section-request">
                        <div class="section-title">Request</div>
                        <div id="request-content"></div>
                    </div>
                    <div class="detail-section" id="section-response">
                        <div class="section-title">Response</div>
                        <div id="response-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Request list -->
        <div class="list-panel">
            <div class="list-controls">
                <div class="search-row">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search requests...">
                    </div>
                    <div class="search-type-toggle">
                        <button class="search-type-btn active" data-type="basic" title="Search by model, endpoint">Basic</button>
                        <button class="search-type-btn" data-type="fulltext" title="Full-text search in request/response bodies">Full-text</button>
                    </div>
                </div>
                <div class="controls-row">
                    <div class="per-page-select">
                        <label for="per-page">Show:</label>
                        <select id="per-page">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="request-count" id="request-count">0 requests</div>
                </div>
            </div>

            <div class="request-list" id="request-list">
                <div class="empty-list" id="empty-state">
                    <h3>No requests yet</h3>
                    <p>Requests will appear here as they are made.</p>
                </div>
            </div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let perPage = 50;
        let totalPages = 1;
        let searchQuery = '';
        let searchType = 'basic';
        let searchTimeout = null;
        let selectedRequestId = null;
        let currentRequestData = null;

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function getStateLabel(state) {
            const labels = {
                'pending': 'Pending',
                'sending': 'Sending',
                'receiving': 'Receiving',
                'completed': 'Completed',
                'error': 'Error'
            };
            return labels[state] || state || 'Unknown';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function syntaxHighlight(json) {
            if (json === null || json === undefined) {
                return '<span class="json-null">null</span>';
            }
            if (typeof json !== 'string') {
                json = JSON.stringify(json, null, 2);
            }
            // Escape HTML
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function renderParsedRequest(requestBody) {
            if (!requestBody) return '<div class="message-box">No request body</div>';

            let html = '<div class="parsed-content">';

            // Handle system message
            const system = requestBody.system;
            if (system) {
                html += `<div class="message-box role-system">
                    <div class="message-role">System</div>
                    <div class="message-content">`;
                if (typeof system === 'string') {
                    html += `<pre>${escapeHtml(system)}</pre>`;
                } else if (Array.isArray(system)) {
                    for (const block of system) {
                        if (block.type === 'text') {
                            html += `<pre>${escapeHtml(block.text || '')}</pre>`;
                        }
                    }
                }
                html += `</div></div>`;
            }

            // Handle messages
            const messages = requestBody.messages || [];
            for (const msg of messages) {
                const role = msg.role || 'unknown';
                const roleClass = `role-${role}`;

                html += `<div class="message-box ${roleClass}">
                    <div class="message-role">${escapeHtml(role)}</div>
                    <div class="message-content">`;

                const content = msg.content;
                if (typeof content === 'string') {
                    html += `<pre>${escapeHtml(content)}</pre>`;
                } else if (Array.isArray(content)) {
                    for (const block of content) {
                        html += `<div class="content-block">`;
                        const blockType = block.type || 'unknown';
                        html += `<div class="content-block-type">${escapeHtml(blockType)}</div>`;

                        if (blockType === 'text') {
                            html += `<pre>${escapeHtml(block.text || '')}</pre>`;
                        } else if (blockType === 'thinking') {
                            html += `<pre>${escapeHtml(block.thinking || '')}</pre>`;
                        } else if (blockType === 'tool_use') {
                            html += `<div class="tool-use-block">
                                <div class="tool-use-name">${escapeHtml(block.name || 'Unknown Tool')}</div>
                                <div class="tool-use-input">${escapeHtml(JSON.stringify(block.input || {}, null, 2))}</div>
                            </div>`;
                        } else if (blockType === 'tool_result') {
                            html += `<div class="tool-use-block">
                                <div class="tool-use-name">Result for: ${escapeHtml(block.tool_use_id || '')}</div>
                                <div class="tool-use-input">${escapeHtml(typeof block.content === 'string' ? block.content : JSON.stringify(block.content || {}, null, 2))}</div>
                            </div>`;
                        } else if (blockType === 'image') {
                            html += `<div>[Image: ${escapeHtml(block.source?.media_type || 'unknown type')}]</div>`;
                        } else {
                            html += `<pre>${escapeHtml(JSON.stringify(block, null, 2))}</pre>`;
                        }
                        html += `</div>`;
                    }
                } else if (content) {
                    html += `<pre>${escapeHtml(JSON.stringify(content, null, 2))}</pre>`;
                }

                html += `</div></div>`;
            }

            html += '</div>';
            return html;
        }

        function renderParsedResponse(responseBody) {
            if (!responseBody) return '<div class="message-box">No response body</div>';

            let html = '<div class="parsed-content">';

            // Response is typically an assistant message
            html += `<div class="message-box role-assistant">
                <div class="message-role">Assistant Response</div>
                <div class="message-content">`;

            const content = responseBody.content;
            if (typeof content === 'string') {
                html += `<pre>${escapeHtml(content)}</pre>`;
            } else if (Array.isArray(content)) {
                for (const block of content) {
                    html += `<div class="content-block">`;
                    const blockType = block.type || 'unknown';
                    html += `<div class="content-block-type">${escapeHtml(blockType)}</div>`;

                    if (blockType === 'text') {
                        html += `<pre>${escapeHtml(block.text || '')}</pre>`;
                    } else if (blockType === 'thinking') {
                        html += `<pre>${escapeHtml(block.thinking || '')}</pre>`;
                    } else if (blockType === 'tool_use') {
                        html += `<div class="tool-use-block">
                            <div class="tool-use-name">${escapeHtml(block.name || 'Unknown Tool')}</div>
                            <div class="tool-use-input">${escapeHtml(JSON.stringify(block.input || {}, null, 2))}</div>
                        </div>`;
                    } else {
                        html += `<pre>${escapeHtml(JSON.stringify(block, null, 2))}</pre>`;
                    }
                    html += `</div>`;
                }
            } else if (content) {
                html += `<pre>${escapeHtml(JSON.stringify(content, null, 2))}</pre>`;
            }

            html += `</div></div>`;

            // Show usage info if available
            const usage = responseBody.usage;
            if (usage) {
                html += `<div class="message-box role-system">
                    <div class="message-role">Usage</div>
                    <div class="message-content">
                        <pre>${escapeHtml(JSON.stringify(usage, null, 2))}</pre>
                    </div>
                </div>`;
            }

            html += '</div>';
            return html;
        }

        function updateDetailView() {
            if (!currentRequestData) return;

            const data = currentRequestData;
            const showOverview = document.getElementById('show-overview').checked;
            const showRequest = document.getElementById('show-request').checked;
            const showResponse = document.getElementById('show-response').checked;
            const parseRequest = document.getElementById('parse-request').checked;
            const parseResponse = document.getElementById('parse-response').checked;

            // Toggle section visibility
            document.getElementById('section-overview').classList.toggle('hidden', !showOverview);
            document.getElementById('section-request').classList.toggle('hidden', !showRequest);
            document.getElementById('section-response').classList.toggle('hidden', !showResponse);

            // Update request content
            const requestContent = document.getElementById('request-content');
            if (parseRequest) {
                requestContent.innerHTML = renderParsedRequest(data.request_body);
            } else {
                requestContent.innerHTML = `<pre class="json-display">${syntaxHighlight(data.request_body)}</pre>`;
            }

            // Update response content
            const responseContent = document.getElementById('response-content');
            if (parseResponse) {
                responseContent.innerHTML = renderParsedResponse(data.response_body);
            } else {
                responseContent.innerHTML = `<pre class="json-display">${syntaxHighlight(data.response_body)}</pre>`;
            }
        }

        async function loadRequests() {
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    per_page: perPage,
                });

                let endpoint = '/api/requests';
                if (searchQuery) {
                    if (searchType === 'fulltext') {
                        endpoint = '/api/requests/search';
                        params.set('q', searchQuery);
                    } else {
                        params.set('search', searchQuery);
                    }
                }

                const response = await fetch(endpoint + '?' + params.toString());
                const data = await response.json();

                totalPages = data.total_pages || 1;

                const listContainer = document.getElementById('request-list');
                const requestCount = document.getElementById('request-count');

                requestCount.textContent = `${data.total || 0} requests`;

                if (data.items && data.items.length > 0) {
                    // Build list HTML
                    let html = '';
                    for (const item of data.items) {
                        const state = item.state || 'completed';
                        const isSelected = item.id === selectedRequestId;
                        const duration = item.duration !== null ? `${item.duration}s` : '-';
                        const timestamp = new Date(item.timestamp).toLocaleTimeString();
                        const date = new Date(item.timestamp).toLocaleDateString();

                        // Show translated model if different from original
                        let modelDisplay = item.model;
                        if (item.translated_model && item.translated_model !== item.model) {
                            modelDisplay = `${item.model}<span class="model-translated">‚Üí ${item.translated_model}</span>`;
                        }

                        html += `
                            <div class="request-item ${isSelected ? 'selected' : ''}" data-id="${item.id}" onclick="selectRequest('${item.id}')">
                                <div class="request-item-header">
                                    <span class="request-item-time">${date} ${timestamp}</span>
                                    <span class="state-badge ${state}">${getStateLabel(state)}</span>
                                </div>
                                <div class="request-item-badges">
                                    <span class="model-badge">${modelDisplay}</span>
                                    <span class="endpoint-badge">${item.endpoint}</span>
                                </div>
                                <div class="request-item-stats">
                                    <span>Duration: ${duration}</span>
                                    <span>In: ${formatNumber(item.input_tokens)} / Out: ${formatNumber(item.output_tokens)}</span>
                                </div>
                            </div>
                        `;
                    }

                    // Preserve scroll position if possible
                    const scrollTop = listContainer.scrollTop;
                    listContainer.innerHTML = html;
                    listContainer.scrollTop = scrollTop;
                } else {
                    listContainer.innerHTML = `
                        <div class="empty-list" id="empty-state" style="display: flex;">
                            <h3>No requests yet</h3>
                            <p>Requests will appear here as they are made.</p>
                        </div>
                    `;
                }

                renderPagination(data.total);
            } catch (error) {
                console.error('Failed to load requests:', error);
            }
        }

        function renderPagination(total) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Üê';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadRequests();
                }
            };
            pagination.appendChild(prevBtn);

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                pagination.appendChild(createPageButton(1));
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-info';
                    pagination.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                pagination.appendChild(createPageButton(i));
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-info';
                    pagination.appendChild(ellipsis);
                }
                pagination.appendChild(createPageButton(totalPages));
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadRequests();
                }
            };
            pagination.appendChild(nextBtn);
        }

        function createPageButton(page) {
            const btn = document.createElement('button');
            btn.textContent = page;
            btn.className = page === currentPage ? 'active' : '';
            btn.onclick = () => {
                currentPage = page;
                loadRequests();
            };
            return btn;
        }

        async function selectRequest(requestId) {
            selectedRequestId = requestId;

            // Update selection in list
            document.querySelectorAll('.request-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.id === requestId);
            });

            try {
                const response = await fetch(`/api/request/${requestId}`);
                const data = await response.json();

                showRequestDetails(data);
            } catch (error) {
                console.error('Failed to load request details:', error);
            }
        }

        function showRequestDetails(data) {
            currentRequestData = data;

            document.getElementById('detail-empty').style.display = 'none';
            document.getElementById('detail-panes').style.display = 'block';
            document.getElementById('detail-controls').style.display = 'flex';

            const state = data.state || 'completed';
            const statusCode = data.status_code !== null ? data.status_code : '-';
            const duration = data.duration !== null ? `${data.duration}s` : '-';

            // Show translated model in header if different
            let modelDisplay = data.model;
            if (data.translated_model && data.translated_model !== data.model) {
                modelDisplay = `${data.model} ‚Üí ${data.translated_model}`;
            }

            document.getElementById('detail-header').innerHTML = `
                <h2>
                    <span class="model-badge">${modelDisplay}</span>
                    <span class="endpoint-badge">${data.endpoint}</span>
                    <span class="state-badge ${state}">${getStateLabel(state)}</span>
                </h2>
            `;

            const overviewContent = document.getElementById('overview-content');
            let overviewHtml = `
                <div class="overview-item">
                    <label>Request ID</label>
                    <div class="value">${data.id}</div>
                </div>
                <div class="overview-item">
                    <label>Timestamp</label>
                    <div class="value">${new Date(data.timestamp).toLocaleString()}</div>
                </div>
                <div class="overview-item">
                    <label>Model</label>
                    <div class="value">${data.model}</div>
                </div>`;

            if (data.translated_model && data.translated_model !== data.model) {
                overviewHtml += `
                <div class="overview-item">
                    <label>Translated Model</label>
                    <div class="value">${data.translated_model}</div>
                </div>`;
            }

            overviewHtml += `
                <div class="overview-item">
                    <label>Endpoint</label>
                    <div class="value">${data.endpoint}</div>
                </div>
                <div class="overview-item">
                    <label>Status Code</label>
                    <div class="value">${statusCode}</div>
                </div>
                <div class="overview-item">
                    <label>Duration</label>
                    <div class="value">${duration}</div>
                </div>
                <div class="overview-item">
                    <label>Request Size</label>
                    <div class="value">${formatBytes(data.request_size)}</div>
                </div>
                <div class="overview-item">
                    <label>Response Size</label>
                    <div class="value">${formatBytes(data.response_size)}</div>
                </div>
                <div class="overview-item">
                    <label>Input Tokens</label>
                    <div class="value">${formatNumber(data.input_tokens)}</div>
                </div>
                <div class="overview-item">
                    <label>Output Tokens</label>
                    <div class="value">${formatNumber(data.output_tokens)}</div>
                </div>
            `;
            overviewContent.innerHTML = overviewHtml;

            // Update the detail view based on checkbox states
            updateDetailView();
        }

        // Checkbox event listeners
        document.getElementById('show-overview').addEventListener('change', updateDetailView);
        document.getElementById('show-request').addEventListener('change', updateDetailView);
        document.getElementById('show-response').addEventListener('change', updateDetailView);
        document.getElementById('parse-request').addEventListener('change', updateDetailView);
        document.getElementById('parse-response').addEventListener('change', updateDetailView);

        // Search type toggle
        document.querySelectorAll('.search-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.search-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                searchType = btn.dataset.type;

                // Update placeholder
                const input = document.getElementById('search-input');
                if (searchType === 'fulltext') {
                    input.placeholder = 'Search in request/response bodies...';
                } else {
                    input.placeholder = 'Search by model, endpoint...';
                }

                // Trigger search if there's a query
                if (searchQuery) {
                    currentPage = 1;
                    loadRequests();
                }
            });
        });

        // Search input with debounce
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = e.target.value.trim();
                currentPage = 1;
                loadRequests();
            }, 300);
        });

        // Per page selector
        document.getElementById('per-page').addEventListener('change', (e) => {
            perPage = parseInt(e.target.value);
            currentPage = 1;
            loadRequests();
        });

        // Download requests as JSON Lines
        async function downloadRequests() {
            try {
                const response = await fetch('/api/requests/export');
                const blob = await response.blob();

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `requests_${new Date().toISOString().slice(0, 10)}.jl`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download requests:', error);
                alert('Failed to download requests: ' + error.message);
            }
        }

        // Upload requests from JSON Lines
        async function uploadRequests(input) {
            const file = input.files[0];
            if (!file) return;

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/requests/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Successfully imported ${result.imported} requests`);
                    loadRequests();
                } else {
                    alert('Failed to import: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to upload requests:', error);
                alert('Failed to upload requests: ' + error.message);
            } finally {
                // Reset file input
                input.value = '';
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Navigate list with arrow keys when no input is focused
            if (document.activeElement.tagName !== 'INPUT') {
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    const items = document.querySelectorAll('.request-item');
                    if (items.length === 0) return;

                    let currentIndex = -1;
                    items.forEach((item, index) => {
                        if (item.classList.contains('selected')) {
                            currentIndex = index;
                        }
                    });

                    let newIndex;
                    if (e.key === 'ArrowDown') {
                        newIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
                    } else {
                        newIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                    }

                    const newItem = items[newIndex];
                    selectRequest(newItem.dataset.id);
                    newItem.scrollIntoView({ block: 'nearest' });
                }
            }

            // Focus search with /
            if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                document.getElementById('search-input').focus();
            }
        });

        // Initial load
        loadRequests();
    </script>
</body>
</html>
